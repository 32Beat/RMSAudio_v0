////////////////////////////////////////////////////////////////////////////////
/*
	rmsdelay_t
	
	Created by 32BT on 15/11/15.
	Copyright Â© 2015 32BT. All rights reserved.
*/
////////////////////////////////////////////////////////////////////////////////


#include "rmsdelay_t.h"


////////////////////////////////////////////////////////////////////////////////
#pragma mark
////////////////////////////////////////////////////////////////////////////////

rmsdelay_t RMSDelayBegin(void)
{ return RMSBufferBegin(1024*1024); }

////////////////////////////////////////////////////////////////////////////////

void RMSDelayEnd(rmsdelay_t *delay)
{ return RMSBufferEnd(delay); }

////////////////////////////////////////////////////////////////////////////////

float RMSDelayProcessSample(rmsdelay_t *delay, float offset, float feedBack, float S)
{
	float R = RMSBufferGetSampleWithDelay(delay, offset);
	
	S += feedBack * R;
	
	RMSBufferWriteSample(delay, S);
	
	return S;
}

////////////////////////////////////////////////////////////////////////////////

float RMSDelayProcessSampleMT(rmsdelay_t *delay, float offset, float feedBack, float S)
{
	float R = 0;

	uint64_t T1 = 0;
	uint64_t T2 = offset;
	while ((T2-T1) > 1)
	{
		T1 = (T1+T2)>>1;
		R += 0.5 * (RMSBufferGetSampleWithDelay(delay, T1) - R);
	}
	
	R += 0.5 * (RMSBufferGetSampleWithDelay(delay, T2)-R);
		
	S += feedBack * R;
	
	RMSBufferWriteSample(delay, S);
	
	return S;
}

////////////////////////////////////////////////////////////////////////////////


